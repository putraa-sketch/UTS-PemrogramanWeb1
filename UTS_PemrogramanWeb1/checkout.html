<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemesanan - Toko Buku Online</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>ðŸ“š Toko Buku Online</h1>
            <div class="user-info">
                <span id="userName">User</span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="grid grid-2">
            <!-- Pilih Buku -->
            <div class="card">
                <h2>Pilih Buku</h2>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="searchBuku" placeholder="Cari buku..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div id="listBuku" style="max-height: 500px; overflow-y: auto;">
                </div>
            </div>

            <!-- Keranjang -->
            <div class="card">
                <h2>Keranjang Belanja</h2>
                <div id="keranjangList" style="margin-bottom: 20px;">
                    <p style="text-align: center; color: #999; padding: 20px;">Keranjang masih kosong</p>
                </div>
                <div style="border-top: 2px solid #667eea; padding-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1rem; font-weight: bold;">
                        <span>Total:</span>
                        <span id="totalHarga">Rp 0</span>
                    </div>
                    <button class="btn btn-success btn-block" id="btnCheckout">Proses Checkout</button>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <a href="dashboard.html" class="btn btn-secondary">Kembali ke Dashboard</a>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/script.js"></script>
    <script>
        // Cek login
        const loginData = checkLogin();
        document.getElementById('userName').textContent = loginData.nama;

        // Variable keranjang
        let keranjang = getCart();

        // Fungsi untuk render daftar buku
        function renderDaftarBuku(data = dataKatalogBuku) {
            const listBuku = document.getElementById('listBuku');
            listBuku.innerHTML = '';

            if (data.length === 0) {
                listBuku.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Tidak ada buku ditemukan</p>';
                return;
            }

            data.forEach(buku => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; transition: all 0.3s;';
                itemDiv.innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: start;">
                        <img src="${buku.cover}" alt="${buku.namaBarang}" style="width: 80px; height: 110px; object-fit: cover; border-radius: 5px;" onerror="this.src='https://via.placeholder.com/80x110?text=No+Image'">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0; color: #667eea;">${buku.namaBarang}</h4>
                            <p style="margin: 5px 0; font-size: 0.9rem; color: #666;">
                                <strong>Kode:</strong> ${buku.kodeBarang}<br>
                                <strong>Jenis:</strong> ${buku.jenisBarang}<br>
                                <strong>Edisi:</strong> ${buku.edisi}<br>
                                <strong>Harga:</strong> <span style="color: #667eea; font-weight: bold;">${buku.harga}</span><br>
                                <strong>Stok:</strong> <span style="color: ${buku.stok > 200 ? '#27ae60' : buku.stok > 100 ? '#f39c12' : '#e74c3c'}; font-weight: bold;">${buku.stok}</span>
                            </p>
                            <button class="btn btn-primary" onclick="tambahKeKeranjang('${buku.kodeBarang}')" ${buku.stok === 0 ? 'disabled' : ''} style="margin-top: 10px;">
                                ${buku.stok === 0 ? 'Habis' : '+ Keranjang'}
                            </button>
                        </div>
                    </div>
                `;
                listBuku.appendChild(itemDiv);
            });
        }

        // Fungsi tambah ke keranjang
        function tambahKeKeranjang(kodeBarang) {
            const buku = dataKatalogBuku.find(b => b.kodeBarang === kodeBarang);
            if (!buku || buku.stok === 0) {
                showAlert('Buku tidak tersedia!', 'error');
                return;
            }

            const existingItem = keranjang.find(item => item.kodeBarang === kodeBarang);
            
            if (existingItem) {
                if (existingItem.qty >= buku.stok) {
                    showAlert('Stok tidak mencukupi!', 'error');
                    return;
                }
                existingItem.qty++;
            } else {
                keranjang.push({
                    kodeBarang: buku.kodeBarang,
                    namaBarang: buku.namaBarang,
                    harga: buku.harga,
                    qty: 1,
                    stokTersedia: buku.stok
                });
            }

            saveCart(keranjang);
            renderKeranjang();
            showAlert('Buku ditambahkan ke keranjang!', 'success');
        }

        // Fungsi render keranjang
        function renderKeranjang() {
            const keranjangList = document.getElementById('keranjangList');
            
            if (keranjang.length === 0) {
                keranjangList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Keranjang masih kosong</p>';
                document.getElementById('totalHarga').textContent = 'Rp 0';
                return;
            }

            keranjangList.innerHTML = keranjang.map(item => `
                <div style="border-bottom: 1px solid #eee; padding: 10px 0; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #667eea;">${item.namaBarang}</strong>
                        <button onclick="hapusDariKeranjang('${item.kodeBarang}')" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Kode: ${item.kodeBarang}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="kurangiQty('${item.kodeBarang}')" class="btn btn-secondary" style="padding: 4px 10px;">-</button>
                            <span style="min-width: 30px; text-align: center; font-weight: bold;">${item.qty}</span>
                            <button onclick="tambahQty('${item.kodeBarang}')" class="btn btn-primary" style="padding: 4px 10px;">+</button>
                        </div>
                        <span style="font-weight: bold;">${formatRupiah(parseHarga(item.harga) * item.qty)}</span>
                    </div>
                </div>
            `).join('');

            const total = calculateCartTotal(keranjang);
            document.getElementById('totalHarga').textContent = formatRupiah(total);
        }

        // Fungsi hapus dari keranjang
        function hapusDariKeranjang(kodeBarang) {
            keranjang = keranjang.filter(item => item.kodeBarang !== kodeBarang);
            saveCart(keranjang);
            renderKeranjang();
            showAlert('Item dihapus dari keranjang!', 'info');
        }

        // Fungsi tambah qty
        function tambahQty(kodeBarang) {
            const item = keranjang.find(i => i.kodeBarang === kodeBarang);
            if (item && item.qty < item.stokTersedia) {
                item.qty++;
                saveCart(keranjang);
                renderKeranjang();
            } else {
                showAlert('Stok tidak mencukupi!', 'error');
            }
        }

        // Fungsi kurangi qty
        function kurangiQty(kodeBarang) {
            const item = keranjang.find(i => i.kodeBarang === kodeBarang);
            if (item && item.qty > 1) {
                item.qty--;
                saveCart(keranjang);
                renderKeranjang();
            }
        }

        // Fungsi checkout
        document.getElementById('btnCheckout').addEventListener('click', function() {
            if (keranjang.length === 0) {
                showAlert('Keranjang masih kosong!', 'error');
                return;
            }

            const total = calculateCartTotal(keranjang);
            const content = `
                <form id="formCheckout">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Informasi Pemesan</h3>
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" id="namaPemesan" value="${loginData.nama}" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="emailPemesan" value="${loginData.email}" required>
                    </div>
                    <div class="form-group">
                        <label>No. Telepon *</label>
                        <input type="tel" id="telpPemesan" required placeholder="08123456789">
                    </div>
                    <div class="form-group">
                        <label>Alamat Lengkap *</label>
                        <textarea id="alamatPemesan" rows="3" required placeholder="Masukkan alamat lengkap"></textarea>
                    </div>
                    
                    <h3 style="color: #667eea; margin: 20px 0 15px 0;">Informasi Pembayaran</h3>
                    <div class="form-group">
                        <label>Metode Pembayaran *</label>
                        <select id="metodePembayaran" required>
                            <option value="">Pilih Metode</option>
                            <option value="Transfer Bank">Transfer Bank</option>
                            <option value="E-Wallet">E-Wallet (GoPay/OVO/DANA)</option>
                            <option value="COD">COD (Cash on Delivery)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ekspedisi *</label>
                        <select id="ekspedisi" required>
                            <option value="">Pilih Ekspedisi</option>
                            <option value="JNE">JNE</option>
                            <option value="Pos Indonesia">Pos Indonesia</option>
                            <option value="J&T">J&T Express</option>
                            <option value="SiCepat">SiCepat</option>
                        </select>
                    </div>
                    
                    <div style="border-top: 2px solid #667eea; padding-top: 15px; margin-top: 20px;">
                        <h4>Ringkasan Pesanan:</h4>
                        <div style="margin: 10px 0;">
                            ${keranjang.map(item => `
                                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                    <span>${item.namaBarang} (${item.qty}x)</span>
                                    <span>${formatRupiah(parseHarga(item.harga) * item.qty)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; color: #667eea; margin-top: 10px;">
                            <span>Total:</span>
                            <span>${formatRupiah(total)}</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-block" style="margin-top: 20px;">Konfirmasi Pesanan</button>
                </form>
            `;
            createModal('Checkout Pesanan', content);

            setTimeout(() => {
                document.getElementById('formCheckout').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const nama = document.getElementById('namaPemesan').value;
                    const email = document.getElementById('emailPemesan').value;
                    const telp = document.getElementById('telpPemesan').value;
                    const alamat = document.getElementById('alamatPemesan').value;
                    const metode = document.getElementById('metodePembayaran').value;
                    const ekspedisi = document.getElementById('ekspedisi').value;

                    // Validasi
                    if (!validateEmail(email)) {
                        showAlert('Format email tidak valid!', 'error');
                        return;
                    }

                    if (!validateRequired(telp) || !validateRequired(alamat)) {
                        showAlert('Mohon lengkapi semua data!', 'error');
                        return;
                    }

                    // Generate nomor DO
                    const nomorDO = '202300' + String(Math.floor(Math.random() * 100) + 14);
                    
                    closeModal();
                    
                    // Clear keranjang
                    keranjang = [];
                    saveCart(keranjang);
                    renderKeranjang();

                    // Show success message
                    setTimeout(() => {
                        const successContent = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 4rem; color: #27ae60; margin-bottom: 20px;">âœ“</div>
                                <h3 style="color: #27ae60; margin-bottom: 15px;">Pesanan Berhasil!</h3>
                                <p style="margin-bottom: 20px;">Pesanan Anda telah berhasil diproses.</p>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <p style="margin: 5px 0;"><strong>Nomor DO:</strong> ${nomorDO}</p>
                                    <p style="margin: 5px 0;"><strong>Nama:</strong> ${nama}</p>
                                    <p style="margin: 5px 0;"><strong>Total:</strong> ${formatRupiah(total)}</p>
                                    <p style="margin: 5px 0;"><strong>Metode:</strong> ${metode}</p>
                                    <p style="margin: 5px 0;"><strong>Ekspedisi:</strong> ${ekspedisi}</p>
                                </div>
                                <p style="color: #666; font-size: 0.9rem;">Gunakan nomor DO untuk melacak pesanan Anda di menu Tracking Pengiriman.</p>
                                <button class="btn btn-primary btn-block" onclick="closeModal()">Tutup</button>
                            </div>
                        `;
                        createModal('Pesanan Berhasil', successContent);
                    }, 300);
                });
            }, 100);
        });

        // Fungsi pencarian buku
        document.getElementById('searchBuku').addEventListener('input', function(e) {
            const keyword = e.target.value.toLowerCase();
            const filtered = dataKatalogBuku.filter(buku => 
                buku.namaBarang.toLowerCase().includes(keyword) ||
                buku.kodeBarang.toLowerCase().includes(keyword)
            );
            renderDaftarBuku(filtered);
        });

        // Render pertama kali
        renderDaftarBuku();
        renderKeranjang();
    </script>
</body>
</html>